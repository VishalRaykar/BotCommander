{% extends "base.html" %}

{% block title %}Admin Panel - BotCommander{% endblock %}

{% block content %}
<div class="admin-container">
    <div class="admin-header">
        <h1><i class="fas fa-user-shield"></i> Admin Panel</h1>
    </div>
    
    <div class="admin-tabs">
        <button class="tab-btn active" data-tab="users">Users</button>
        <button class="tab-btn" data-tab="assign-bots">Assign Bots</button>
    </div>
    
    <!-- Users Tab -->
    <div class="tab-content active" id="users-tab">
        <div class="section-header">
            <h2>Manage Users</h2>
            <button class="btn btn-primary" id="btnCreateUser">
                <i class="fas fa-plus"></i> Create User
            </button>
        </div>
        
        <div class="users-list" id="usersList">
            <div class="loading">Loading users...</div>
        </div>
    </div>
    
    <!-- Assign Bots Tab -->
    <div class="tab-content" id="assign-bots-tab">
        <div class="section-header">
            <h2>Assign Bot to User</h2>
        </div>
        
        <form id="assignBotForm" class="form-card">
            <div class="form-group" style="position: relative; min-width: 220px; display: flex; align-items: center;">
                <label for="assignUserId">Select User</label>
                <select id="assignUserId" name="user_id" class="styled-dropdown" required style="width: 100%;">
                    <option value="">-- Select User --</option>
                </select>
            </div>
            <div class="form-group">
                <label for="assignBotId">Bot ID</label>
                <input type="text" id="assignBotId" name="bot_id" required placeholder="Enter bot ID">
            </div>
            <div class="form-group">
                <button type="submit" class="btn btn-primary btn-block">
                    <i class="fas fa-link"></i> Assign Bot
                </button>
            </div>
            <div id="assignError" class="error-message" style="display: none;"></div>
        </form>
    </div>
    
    <!-- Create User Modal -->
    <div class="modal" id="createUserModal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Create New User</h3>
                <button class="modal-close" id="closeModal">&times;</button>
            </div>
            <form id="createUserForm" class="modal-body">
                <div class="form-group">
                    <label for="userEmail">Email</label>
                    <input type="email" id="userEmail" name="email" required>
                </div>
                <div class="form-group">
                    <label for="userName">Name</label>
                    <input type="text" id="userName" name="name" required>
                </div>
                <div class="form-group">
                    <label for="userPassword">Password</label>
                    <input type="password" id="userPassword" name="password" required>
                </div>
                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="userIsAdmin" name="is_admin">
                        <span>Grant admin privileges</span>
                    </label>
                </div>
                <div id="createUserError" class="error-message" style="display: none;"></div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" id="cancelCreateUser">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create User</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Tab switching
document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        const tab = btn.dataset.tab;
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById(tab + '-tab').classList.add('active');
    });
});

// Load users
async function loadUsers() {
    try {
        const response = await api.get('/api/users');
        if (response.ok) {
            const data = await response.json();
            const usersList = document.getElementById('usersList');
            if (data.users && data.users.length > 0) {
                const currentUserId = currentUser ? currentUser.user_id : null;
                usersList.innerHTML = `
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Admin</th>
                                <th>Created On</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.users.map(user => `
                                <tr>
                                    <td>${user.user_id}</td>
                                    <td>${user.name}</td>
                                    <td>${user.email}</td>
                                    <td>
                                        <label class="toggle-switch">
                                            <input type="checkbox" 
                                                   ${user.is_admin ? 'checked' : ''} 
                                                   onchange="toggleAdmin(${user.user_id}, this.checked)"
                                                   ${user.user_id === currentUserId ? 'disabled' : ''}>
                                            <span class="toggle-slider"></span>
                                        </label>
                                    </td>
                                    <td>${new Date(user.created_on).toLocaleDateString()}</td>
                                    <td>
                                        <button class="btn btn-danger btn-sm" onclick="deleteUser(${user.user_id})" 
                                                ${user.user_id === currentUserId ? 'disabled' : ''}>
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } else {
                usersList.innerHTML = '<p class="empty-state">No users found</p>';
            }
            
            // Populate user select for bot assignment
            const select = document.getElementById('assignUserId');
            select.innerHTML = '<option value="">-- Select User --</option>' +
                data.users.map(user => 
                    `<option value="${user.user_id}">${user.name} (${user.email})</option>`
                ).join('');
        } else {
            if (response.status === 403) {
                alert('Admin access required');
                window.location.href = '/dashboard';
            }
        }
    } catch (error) {
        console.error('Error loading users:', error);
    }
}

// Create user modal
document.getElementById('btnCreateUser').addEventListener('click', () => {
    document.getElementById('createUserModal').style.display = 'flex';
});

document.getElementById('closeModal').addEventListener('click', () => {
    document.getElementById('createUserModal').style.display = 'none';
});

document.getElementById('cancelCreateUser').addEventListener('click', () => {
    document.getElementById('createUserModal').style.display = 'none';
    document.getElementById('createUserForm').reset();
});

document.getElementById('createUserForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const errorDiv = document.getElementById('createUserError');
    const formData = {
        email: document.getElementById('userEmail').value,
        name: document.getElementById('userName').value,
        password: document.getElementById('userPassword').value,
        is_admin: document.getElementById('userIsAdmin').checked
    };
    
    try {
        const response = await api.post('/api/users', formData);
        if (response.ok) {
            document.getElementById('createUserModal').style.display = 'none';
            document.getElementById('createUserForm').reset();
            loadUsers();
        } else {
            const data = await response.json();
            errorDiv.textContent = data.error || 'Failed to create user';
            errorDiv.style.display = 'block';
        }
    } catch (error) {
        errorDiv.textContent = 'Network error. Please try again.';
        errorDiv.style.display = 'block';
    }
});

// Assign bot
document.getElementById('assignBotForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const errorDiv = document.getElementById('assignError');
    const formData = {
        user_id: parseInt(document.getElementById('assignUserId').value),
        bot_id: document.getElementById('assignBotId').value
    };
    
    try {
        const response = await api.post('/api/bots', formData);
        if (response.ok) {
            errorDiv.style.display = 'none';
            document.getElementById('assignBotForm').reset();
            alert('Bot assigned successfully!');
        } else {
            const data = await response.json();
            errorDiv.textContent = data.error || 'Failed to assign bot';
            errorDiv.style.display = 'block';
        }
    } catch (error) {
        errorDiv.textContent = 'Network error. Please try again.';
        errorDiv.style.display = 'block';
    }
});

let currentUser = null;

// Toggle admin status
async function toggleAdmin(userId, isAdmin) {
    try {
        const response = await api.put(`/api/users/${userId}`, { is_admin: isAdmin });
        if (response.ok) {
            loadUsers();
        } else {
            const data = await response.json();
            alert(data.error || 'Failed to update user');
            loadUsers(); // Reload to reset toggle
        }
    } catch (error) {
        alert('Network error. Please try again.');
        loadUsers(); // Reload to reset toggle
    }
}

// Delete user
async function deleteUser(userId) {
    if (!confirm('Are you sure you want to delete this user?')) {
        return;
    }
    try {
        const response = await api.delete(`/api/users/${userId}`);
        if (response.ok) {
            loadUsers();
        } else {
            const data = await response.json();
            alert(data.error || 'Failed to delete user');
        }
    } catch (error) {
        alert('Network error. Please try again.');
    }
}

// Check auth and load data
checkAuth().then(async () => {
    const response = await api.get('/api/me');
    if (response.ok) {
        const data = await response.json();
        currentUser = data.user;
    }
    loadUsers();
});
</script>
{% endblock %}

